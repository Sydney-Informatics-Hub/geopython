<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.165">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Sydney Informatics Hub Python for Geoscience – a-simplespeedups</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../lesson.css">
</head>

<body class="nav-fixed">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Sydney Informatics Hub Python for Geoscience</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../setup.html">Setup</a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-session-1" role="button" data-bs-toggle="dropdown" aria-expanded="false">Session 1</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-session-1">    
        <li>
    <a class="dropdown-item" href="../00-intro.html">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../notebooks/01a-fundamentals.html">
 <span class="dropdown-text">Fundamentals</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-session-2" role="button" data-bs-toggle="dropdown" aria-expanded="false">Session 2</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-session-2">    
        <li>
    <a class="dropdown-item" href="../notebooks/01b-dataframes.html">
 <span class="dropdown-text">Useful Python packages for different data types</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-session-3" role="button" data-bs-toggle="dropdown" aria-expanded="false">Session 3</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-session-3">    
        <li>
    <a class="dropdown-item" href="../notebooks/02b-Clustering.html">
 <span class="dropdown-text">Numerical Approaches</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../notebooks/03-ML_workflow.html">
 <span class="dropdown-text">Machine Learning Workflow</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-session-4" role="button" data-bs-toggle="dropdown" aria-expanded="false">Session 4</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-session-4">    
        <li>
    <a class="dropdown-item" href="../notebooks/04a-SimpleSpeedUps.html">
 <span class="dropdown-text">Efficient Python Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../notebooks/02a-mapping.html">
 <span class="dropdown-text">Bonus: Matplotlib and Mapping with Cartopy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../notebooks/03b-DeepLearningTS.html">
 <span class="dropdown-text">Bonus: Deep Learning &amp; Time Series</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../notebooks/04b-DaskDataframes.html">
 <span class="dropdown-text">Bonus: Dask data frames</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../notebooks/merge.html">
 <span class="dropdown-text">Bonus: Merging Text Tables</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../notebooks/PDF2Python.html">
 <span class="dropdown-text">Bonus: Working with PDF files</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../notebooks/text2segy.html">
 <span class="dropdown-text">Bonus: segy2text2segy</span></a>
  </li>  
    </ul>
  </li>
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#efficient-python-methods" id="toc-efficient-python-methods" class="nav-link active" data-scroll-target="#efficient-python-methods">Efficient Python methods</a>
  <ul class="collapse">
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions">Questions</a></li>
  <li><a href="#objectives" id="toc-objectives" class="nav-link" data-scroll-target="#objectives">Objectives</a></li>
  <li><a href="#acceleration-parallelisation-vectorising-threading-make-python-go-fast" id="toc-acceleration-parallelisation-vectorising-threading-make-python-go-fast" class="nav-link" data-scroll-target="#acceleration-parallelisation-vectorising-threading-make-python-go-fast">Acceleration, Parallelisation, Vectorising, Threading, make-Python-go-fast</a>
  <ul class="collapse">
  <li><a href="#what-does-parallel-mean" id="toc-what-does-parallel-mean" class="nav-link" data-scroll-target="#what-does-parallel-mean">What does <em>parallel</em> mean?</a></li>
  </ul></li>
  <li><a href="#profiling-your-code" id="toc-profiling-your-code" class="nav-link" data-scroll-target="#profiling-your-code">Profiling your code</a>
  <ul class="collapse">
  <li><a href="#challenge" id="toc-challenge" class="nav-link" data-scroll-target="#challenge">Challenge</a></li>
  </ul></li>
  <li><a href="#loops-and-vectorising-code-with-numpy-and-pandas" id="toc-loops-and-vectorising-code-with-numpy-and-pandas" class="nav-link" data-scroll-target="#loops-and-vectorising-code-with-numpy-and-pandas">Loops and vectorising code with numpy and pandas</a></li>
  <li><a href="#python-multiprocessing" id="toc-python-multiprocessing" class="nav-link" data-scroll-target="#python-multiprocessing">Python Multiprocessing</a>
  <ul class="collapse">
  <li><a href="#some-terminology---processes-threads-and-shared-memory" id="toc-some-terminology---processes-threads-and-shared-memory" class="nav-link" data-scroll-target="#some-terminology---processes-threads-and-shared-memory">Some terminology - Processes, threads and shared memory</a></li>
  </ul></li>
  <li><a href="#simple-multiprocessing-example" id="toc-simple-multiprocessing-example" class="nav-link" data-scroll-target="#simple-multiprocessing-example">Simple multiprocessing example</a>
  <ul class="collapse">
  <li><a href="#challenge." id="toc-challenge." class="nav-link" data-scroll-target="#challenge.">Challenge.</a></li>
  </ul></li>
  <li><a href="#useful-links" id="toc-useful-links" class="nav-link" data-scroll-target="#useful-links">Useful links</a></li>
  <li><a href="#mpi-message-passing-interface" id="toc-mpi-message-passing-interface" class="nav-link" data-scroll-target="#mpi-message-passing-interface">MPI: Message Passing Interface</a>
  <ul class="collapse">
  <li><a href="#key-points" id="toc-key-points" class="nav-link" data-scroll-target="#key-points">Key points</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="efficient-python-methods" class="level1">
<h1>Efficient Python methods</h1>
<section id="questions" class="level3 questions">
<h3 class="anchored" data-anchor-id="questions">Questions</h3>
<ul>
<li>Which method for acceleration should I choose?</li>
<li>How do I utilise traditional Python approaches to multi cpu and nodes</li>
</ul>
</section>
<section id="objectives" class="level3 objectives">
<h3 class="anchored" data-anchor-id="objectives">Objectives</h3>
<ul>
<li>Learn simples methods to profile your code</li>
<li>See how numpy and pandas use Vectorising to improve performance for some data”</li>
<li>Use MPI to communicate between workers</li>
<li>Discover Python multiprocessing and mpi execution</li>
</ul>
</section>
<p>In this session we will show you a few of the basic tools that we can use in Python to make our code go faster. There is no perfect method for optimising code. Efficiency gains depend on what your end goal is, what libraries are available, what method or approach you want to take when writing algorithms, what your data is like, what hardware you have. Hopefully these notes will allow you to think about your problems from different perspectives to give you the best opportunity to make your development and execution as efficient as possible.</p>
<section id="acceleration-parallelisation-vectorising-threading-make-python-go-fast" class="level2">
<h2 class="anchored" data-anchor-id="acceleration-parallelisation-vectorising-threading-make-python-go-fast">Acceleration, Parallelisation, Vectorising, Threading, make-Python-go-fast</h2>
<p>We will cover a few of the ways that you can potentially speed up Python. As we will learn there are multitudes of methods to make Python code more efficient, and also different implementations of libraries, tools, techniques that can all be utilised depending on how your code and/or data is organised. This is a rich and evolving ecosystem and there is no one perfect way to implement efficiencies.</p>
<p>Some key words that might come up:</p>
<ul>
<li>Vectorisation</li>
<li>MPI message parsing interface</li>
<li>CPU, core, node, thread, process, worker, job, task</li>
<li>Parallelisation</li>
<li>Python decorators and functional programming.</li>
</ul>
<p><br></p>
<section id="what-does-parallel-mean" class="level3">
<h3 class="anchored" data-anchor-id="what-does-parallel-mean">What does <em>parallel</em> mean?</h3>
<p>Separate workers or processes acting in an independent or semi-dependent manner. Independent processes ship data, program files and libraries to an isolated ecosystem where computation is performed. In this case communication between workers can be achieved. Contrastingly there are also shared memory set ups where multiple computational resources are pooled together to work on the same data.</p>
<p>Generally speaking, parallel workflows fit different categories of data handling which can make you think about how to write your code and what approaches to take.</p>
<section id="embarrassingly-parallel" class="level4">
<h4 class="anchored" data-anchor-id="embarrassingly-parallel">Embarrassingly parallel:</h4>
<p>Requires no communication between processors. Utilise shared memory spaces. For example:</p>
<ul>
<li>Running same algorithm for a range of input parameters.</li>
<li>Rendering video frames in computer animation.</li>
<li>Open MP implementations.</li>
</ul>
</section>
<section id="coarsefine-grained-parallel" class="level4">
<h4 class="anchored" data-anchor-id="coarsefine-grained-parallel">Coarse/Fine-grained parallel:</h4>
<p>Requires occasional or frequent communication between processors. Uses a small number of processes on large data. Fine grain uses a large number of small processes with very little communication. But can improves computationally bound problems. For example:</p>
<ul>
<li>Some examples are</li>
<li>Finite difference time-stepping on parallel grid.</li>
<li>Finite element methods.</li>
<li>Parallel tempering and MCMC.</li>
<li>MPI implementations.</li>
</ul>
<p>Traditional implementations of parallelism are done on a low level. However, open source software has <strong><em>evolved</em></strong> dramatically over the last few years allowing more <strong><em>high level implementations and concise ‘pythonic’ syntax</em></strong> that wraps around low level tools.</p>
<p><br></p>
</section>
</section>
</section>
<section id="profiling-your-code" class="level2">
<h2 class="anchored" data-anchor-id="profiling-your-code">Profiling your code</h2>
<p>Before you get stuck into making things fast, it is important to find out what is exactly slow in your code. Is it a particular function running slow? Or are you calling a really fast function a million times? You can save yourself a lot development time by profiling your code to give you an idea for where efficiencies can be found. Try out Jupyter’s <code>%%timeit</code> magic function.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>time.sleep(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 718 µs, sys: 1.02 ms, total: 1.74 ms
Wall time: 1 s</code></pre>
</div>
</div>
<p>A neat little feature to check how fast some of your cells are running. Now let’s profile a simple Python script and then think about how we could make it faster. Put this code in a script (save it as <code>faster.py</code>):</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#A test function to see how you can profile code for speedups</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> waithere():</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"waiting for 1 second"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">1</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add2(a<span class="op">=</span><span class="dv">0</span>,b<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"adding"</span>, a, <span class="st">"and"</span>, b)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(a<span class="op">+</span>b)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Hello, try timing some parts of this code!"</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    waithere()  </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    add2(<span class="dv">4</span>,<span class="dv">7</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    add2(<span class="dv">3</span>,<span class="dv">1</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span><span class="op">==</span><span class="st">'__main__'</span>:</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hello, try timing some parts of this code!
waiting for 1 second
adding 4 and 7
adding 3 and 1</code></pre>
</div>
</div>
<p>There are several ways to debug and profile Python, a very elegant and built in one is <a href="https://docs.python.org/3/library/profile.html">cProfile</a> It analyses your code as it executes. Run it with <code>python -m cProfile faster.py</code> and see the output of the script and the profiling:</p>
<pre><code>Hello, try timing some parts of this code!
waiting for 1 second
adding 4 and 7
adding 3 and 1

12 function calls in 1.008 seconds

Ordered by: standard name

ncalls  tottime  percall  cumtime  percall filename:lineno(function)
1    0.000    0.000    1.008    1.008 faster.py:12(main)
1    0.000    0.000    1.008    1.008 faster.py:2(&lt;module&gt;)
1    0.000    0.000    1.002    1.002 faster.py:4(waithere)
2    0.000    0.000    0.005    0.003 faster.py:8(add2)
1    0.000    0.000    1.008    1.008 {built-in method builtins.exec}
4    0.007    0.002    0.007    0.002 {built-in method builtins.print}
1    1.001    1.001    1.001    1.001 {built-in method time.sleep}
1    0.000    0.000    0.000    0.000 {method 'disable' of '_lsprof.Profiler' objects}</code></pre>
<p>You can now interrogate your code and see where you should devote your time to improving it.</p>
<p>Special note on style: Developing python software in a <strong><em>modular</em></strong> manner assists with debugging and time profiling. This is a bit different to the sequential notebooks we have been creating. But re-writing certain snippets in self-contained functions can be a fun task.</p>
<section id="challenge" class="level3 challenge">
<h3 class="anchored" data-anchor-id="challenge">Challenge</h3>
<p>Revisit some of the codes we have run previously. You can do this from a Jupyter Notebook by clicking <code>File &gt; Downlad as &gt; Python (.py)</code>. You may need to comment-out some sections, espiecially where figures are displayed, to get them to run. Run it using <strong>cProfile</strong> and look at the results. Can you identify where improvements could be made?</p>
<details>
<summary>
Solution
</summary>
<p>Discuss together</p>
</details>
</section>
</section>
<section id="loops-and-vectorising-code-with-numpy-and-pandas" class="level2">
<h2 class="anchored" data-anchor-id="loops-and-vectorising-code-with-numpy-and-pandas">Loops and vectorising code with numpy and pandas</h2>
<p>Your problem might be solved by using the fast way certain packages handle certain datatypes.</p>
<p>Generally speaking, pandas and numpy libraries should be libraries you frequently use. They offer advantages in high performance computing including: 1. Efficient datastructures that under the hood are implemented in fast C code rather than python. 2. Promoting explicit use of datatype declarations - making memory management of data and functions working on this data, faster. 3. Elegant syntax promoting consice behaviour. 4. Data structures come with common built in functions that are designed to be used in a vectorised way.</p>
<p>Lets explore this last point on vectorisation with an example. Take this nested for loop example:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#import packages</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#Create some fake data to work with</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>Samples <span class="op">=</span> pd.DataFrame(np.random.randint(<span class="dv">0</span>,<span class="dv">100</span>,size<span class="op">=</span>(<span class="dv">1000</span>, <span class="dv">4</span>)), columns<span class="op">=</span><span class="bu">list</span>([<span class="st">'Alpha'</span>,<span class="st">'Beta'</span>,<span class="st">'Gamma'</span>,<span class="st">'Delta'</span>]))</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>Wells <span class="op">=</span> pd.DataFrame(np.random.randint(<span class="dv">0</span>,<span class="dv">100</span>,size<span class="op">=</span>(<span class="dv">50</span>, <span class="dv">1</span>)), columns<span class="op">=</span><span class="bu">list</span>([<span class="st">'Alpha'</span>]))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">#This could perhaps be the id of a well and the list of samples found in the well. </span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">#You want to match up the samples with some other list, </span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">#perhaps the samples from some larger database like PetDB.</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Create an emtpy dataframe to fill with the resulting matches</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>totalSlow<span class="op">=</span>pd.DataFrame(columns<span class="op">=</span>Samples.columns)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>totalFast<span class="op">=</span>pd.DataFrame(columns<span class="op">=</span>Samples.columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Now compare the nested for-loop method:</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>tic<span class="op">=</span>time.time()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index,samp <span class="kw">in</span> Samples.iterrows():</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index2,well <span class="kw">in</span> Wells.iterrows():</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> well[<span class="st">'Alpha'</span>]<span class="op">==</span>samp[<span class="st">'Alpha'</span>]:</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>            totalSlow<span class="op">=</span>pd.concat([totalSlow, samp])</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>totalSlow<span class="op">=</span>totalSlow.drop_duplicates()</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>toc<span class="op">=</span>time.time()</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Nested-loop Runtime:"</span>,toc<span class="op">-</span>tic, <span class="st">"seconds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Nested-loop Runtime: 1.8003878593444824 seconds</code></pre>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Or the vectorised method:</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>tic<span class="op">=</span>time.time()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>totalFast<span class="op">=</span>Samples[Samples[<span class="st">'Alpha'</span>].isin(Wells.Alpha.tolist())]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>totalFast<span class="op">=</span>totalSlow.drop_duplicates()</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>toc<span class="op">=</span>time.time()</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Vectorized Runtime:"</span>,toc<span class="op">-</span>tic, <span class="st">"seconds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Vectorized Runtime: 0.0013341903686523438 seconds</code></pre>
</div>
</div>
<p>Which one is faster? Note the use of some really basic timing functions, these can help you understand the speed of your code.</p>
</section>
<section id="python-multiprocessing" class="level2">
<h2 class="anchored" data-anchor-id="python-multiprocessing">Python Multiprocessing</h2>
<p>From within Python you may need a flexible way to manage computational resources. This is traditionally done with the <strong><em>multiprocessing</em></strong> library.</p>
<p>With multiprocessing, Python creates new processes. A process here can be thought of as almost a completely different program, though technically they are usually defined as a collection of resources where the resources include memory, file handles and things like that.</p>
<p>One way to think about it is that each <strong><em>process runs in its own Python interpreter</em></strong>, and multiprocessing farms out parts of your program to run on each process.</p>
<section id="some-terminology---processes-threads-and-shared-memory" class="level3">
<h3 class="anchored" data-anchor-id="some-terminology---processes-threads-and-shared-memory">Some terminology - Processes, threads and shared memory</h3>
<p>A <strong><em>process</em></strong> is a collection of resources including program files and memory, that operates as an independent entity. Since each process has a seperate memory space, it can operate independently from other processes. It cannot easily access shared data in other processes.</p>
<p>A <strong><em>thread</em></strong> is the unit of execution within a process. A process can have anywhere from just one thread to many threads. Threads are considered lightweight because they use far less resources than processes. Threads also share the same memory space so are not independent.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figure class="figure">
<img src="../fig/process_v_thread.png" title="segment" class="img-fluid figure-img">
</figure>
<p></p><figcaption class="figure-caption">SegmentLocal</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figure class="figure">
<img src="../fig/process_threads_comparison.png" title="segment" class="img-fluid figure-img">
</figure>
<p></p><figcaption class="figure-caption">SegmentLocal</figcaption><p></p>
</figure>
</div>
<p>Back to python, the multiprocessing library was designed to break down the <strong>Global Interpreter Lock (GIL)</strong> that limits one thread to control the Python interpreter.</p>
<p>In Python, the things that are occurring simultaneously are called by different names (thread, task, process). While they all fall under the definition of concurrency (multiple things happening anaologous to different trains of thought), only multiprocessing actually runs these trains of thought at literally the same time. We will only cover multiprocessing here which assists in CPU bound operations - but keep in mind other methods exist (threading), whose implementation tends to be more low level.</p>
</section>
</section>
<section id="simple-multiprocessing-example" class="level2">
<h2 class="anchored" data-anchor-id="simple-multiprocessing-example">Simple multiprocessing example</h2>
<p>Some basic concepts in the multiprocessing library are: 1. the <code>Pool(processes)</code> object creates a pool of processes. <code>processes</code> is the number of worker processes to use (i.e Python interpreters). If <code>processes</code> is <code>None</code> then the number returned by <code>os.cpu_count()</code> is used. 2. The <code>map(function,list)</code> attribute of this object uses the pool to map a defined function to a list/iterator object</p>
<p>To implement multiprocessing in its basic form. You can complete this exercise in a notebook or a script.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Import the libraries we will need</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shapefile</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Check how many cpus are availble on your computer</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>multiprocessing.cpu_count()</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Read in the shapefile that we will use</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> shapefile.Reader(<span class="st">"../data/platepolygons/topology_platepolygons_0.00Ma.shp"</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>recs    <span class="op">=</span> sf.records()</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>shapes  <span class="op">=</span> sf.shapes()</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>fields  <span class="op">=</span> sf.fields</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>Nshp    <span class="op">=</span> <span class="bu">len</span>(shapes)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>polygons<span class="op">=</span>np.arange(Nshp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Get some details about the shapefile. Plot one of the polygons.</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Let us find the areas of each of the polygons in the shapefile.</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(recs[<span class="dv">10</span>])</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>polygonShape<span class="op">=</span>shapes[<span class="dv">10</span>].points</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>poly<span class="op">=</span>np.array(polygonShape)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>plt.plot(poly[:,<span class="dv">0</span>],poly[:,<span class="dv">1</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Record #10: [0, 0.0, 'Global_EarthByte_230-0Ma_GK07_AREPS_PlateBoundaries.gpml', 'Global_EarthByte_230-0Ma_GK07_AREPS.rot', 911, '', 'gpml:TopologicalClosedPlateBoundary', 0.9, 0.0, 'Nazca Plate', '', 'GPlates-ef2e06a7-4086-4062-9df6-1fa3133f50b8', 0, '', 0, 0, 0.0]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="04a-SimpleSpeedUps_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Implement a function to calcualte the area of a polygon.</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Area of Polygon using Shoelace formula</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># http://en.wikipedia.org/wiki/Shoelace_formula</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> PolygonArea(nshp):</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    polygonShape<span class="op">=</span>shapes[nshp].points</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    corners<span class="op">=</span>np.array(polygonShape)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(corners) <span class="co"># of corners</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Area calculation using Shoelace forula</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    area <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        j <span class="op">=</span> (i <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> n</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        area <span class="op">+=</span> corners[i][<span class="dv">0</span>] <span class="op">*</span> corners[j][<span class="dv">1</span>]</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        area <span class="op">-=</span> corners[j][<span class="dv">0</span>] <span class="op">*</span> corners[i][<span class="dv">1</span>]</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    area <span class="op">=</span> <span class="bu">abs</span>(area) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="fl">0.2</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    endtime<span class="op">=</span>time.time() <span class="op">-</span> start_time</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Process </span><span class="sc">{}</span><span class="st"> Finished in </span><span class="sc">{:0.4f}</span><span class="st">s."</span>.<span class="bu">format</span>(nshp,endtime))</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(area)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Run the function for each polygon/plate in the shapefile:</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>Areas1<span class="op">=</span>[]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> polygons:</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    Areas1.append(PolygonArea(i))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Final Runtime"</span>, time.time() <span class="op">-</span> start_time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Process 0 Finished in 0.2053s.
Process 1 Finished in 0.2029s.
Process 2 Finished in 0.2059s.
Process 3 Finished in 0.2017s.
Process 4 Finished in 0.2052s.
Process 5 Finished in 0.2014s.
Process 6 Finished in 0.2039s.
Process 7 Finished in 0.2030s.
Process 8 Finished in 0.2031s.
Process 9 Finished in 0.2019s.
Process 10 Finished in 0.2019s.
Process 11 Finished in 0.2039s.
Process 12 Finished in 0.2031s.
Process 13 Finished in 0.2018s.
Process 14 Finished in 0.2034s.
Process 15 Finished in 0.2017s.
Process 16 Finished in 0.2014s.
Process 17 Finished in 0.2013s.
Process 18 Finished in 0.2018s.
Process 19 Finished in 0.2014s.
Process 20 Finished in 0.2027s.
Process 21 Finished in 0.2025s.
Process 22 Finished in 0.2017s.
Process 23 Finished in 0.2022s.
Process 24 Finished in 0.2029s.
Process 25 Finished in 0.2024s.
Process 26 Finished in 0.2117s.
Process 27 Finished in 0.2013s.
Process 28 Finished in 0.2003s.
Process 29 Finished in 0.2052s.
Process 30 Finished in 0.2029s.
Process 31 Finished in 0.2051s.
Process 32 Finished in 0.2017s.
Process 33 Finished in 0.2016s.
Process 34 Finished in 0.2012s.
Process 35 Finished in 0.2076s.
Process 36 Finished in 0.2027s.
Process 37 Finished in 0.2052s.
Process 38 Finished in 0.2026s.
Process 39 Finished in 0.2046s.
Process 40 Finished in 0.2016s.
Process 41 Finished in 0.2031s.
Process 42 Finished in 0.2022s.
Process 43 Finished in 0.2051s.
Process 44 Finished in 0.2017s.
Process 45 Finished in 0.2010s.
Final Runtime 9.354471921920776</code></pre>
</div>
</div>
<p>Now we will have to run the multiprocessing version <strong>outside of our jupyter environment</strong>. Put the following into a script or download the <a href="https://cloudstor.aarnet.edu.au/plus/s/Q7DpigC2bibIgHT/download">full version here</a>.</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>script false <span class="op">--</span>no<span class="op">-</span><span class="cf">raise</span><span class="op">-</span>error <span class="co">#do not copy this line - it allows us to have this code in the notes and still</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># generate them without error</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Put the below snippet in a code block outside of Jupyter, but this time, use the multiprocessing capabilities</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Because of how the multiprocessing works, it does not behave nicely in Jupyter all the time</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_global(shapes):</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gshapes</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    gshapes <span class="op">=</span> shapes</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> multiprocessing.Pool(initializer<span class="op">=</span>make_global, initargs<span class="op">=</span>(shapes,)) <span class="im">as</span> pool:</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    Areas2 <span class="op">=</span> pool.<span class="bu">map</span>(PolygonArea,polygons)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Final Runtime"</span>, time.time() <span class="op">-</span> start_time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>Process 0 Finished in 0.2148s.
Process 1 Finished in 0.2199s.
Process 30 Finished in 0.2136s.
Process 31 Finished in 0.2135s.
Process 4 Finished in 0.2138s.
Process 5 Finished in 0.2047s.
Process 24 Finished in 0.2137s.
Process 25 Finished in 0.2138s.
Process 34 Finished in 0.2116s.
Process 35 Finished in 0.2124s.
Process 6 Finished in 0.2138s.
Process 7 Finished in 0.2047s.
Process 16 Finished in 0.2137s.
Process 17 Finished in 0.2138s.
Process 38 Finished in 0.2106s.
Process 39 Finished in 0.2124s.
Process 8 Finished in 0.2138s.
Process 9 Finished in 0.2047s.
Process 26 Finished in 0.2137s.
Process 27 Finished in 0.2138s.
Process 42 Finished in 0.2106s.
Process 43 Finished in 0.2124s.
Process 12 Finished in 0.2138s.
Process 13 Finished in 0.2047s.
Process 20 Finished in 0.2137s.
Process 21 Finished in 0.2138s.
Process 32 Finished in 0.2116s.
Process 33 Finished in 0.2124s.
Process 14 Finished in 0.2138s.
Process 15 Finished in 0.2037s.
Process 22 Finished in 0.2137s.
Process 23 Finished in 0.2138s.
Process 40 Finished in 0.2106s.
Process 41 Finished in 0.2124s.
Process 2 Finished in 0.2138s.
Process 3 Finished in 0.2047s.
Process 28 Finished in 0.2137s.
Process 29 Finished in 0.2138s.
Process 44 Finished in 0.2096s.
Process 45 Finished in 0.2124s.
Process 10 Finished in 0.2138s.
Process 11 Finished in 0.2047s.
Process 18 Finished in 0.2137s.
Process 19 Finished in 0.2138s.
Process 36 Finished in 0.2116s.
Process 37 Finished in 0.2124s.
Final Runtime 5.4170615673065186</code></pre>
<p>Is there any speed up? Why are the processes not in order? Is there any overhead?</p>
<section id="challenge." class="level3 challenge">
<h3 class="anchored" data-anchor-id="challenge.">Challenge.</h3>
<ul>
<li>The <em>pyshp/shapefile</em> library contains the function <code>signed_area</code> which can calculate the area of a polygon. Replace the calculation of <strong><em>area</em></strong> using the <em>shoelace</em> formula in the <code>PolygonArea</code> function with the <code>signed_area</code> method:</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>area<span class="op">=</span>shapefile.signed_area(corners)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>How does this change the timings of your speed tests? Hint, it might not be by much.</li>
</ul>
<details>
<summary>
Solution
</summary>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> PolygonArea(nshp):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    area<span class="op">=</span>shapefile.signed_area(corners)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    endtime<span class="op">=</span>time.time() <span class="op">-</span> start_time</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Process </span><span class="sc">{}</span><span class="st"> Finished in </span><span class="sc">{:0.4f}</span><span class="st">s. </span><span class="ch">\n</span><span class="st">"</span>.<span class="bu">format</span>(nshp,endtime))</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(area)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Test the serial version</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>Areas1<span class="op">=</span>[]</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> polygons:</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    Areas1.append(PolygonArea(i))</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Final Runtime"</span>, time.time() <span class="op">-</span> start_time)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Test the multiprocessing version</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> multiprocessing.Pool(initializer<span class="op">=</span>make_global, initargs<span class="op">=</span>(shapes,)) <span class="im">as</span> pool:</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    Areas2 <span class="op">=</span> pool.<span class="bu">map</span>(PolygonArea,polygons)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Final Runtime"</span>, time.time() <span class="op">-</span> start_time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There is generally a sweet spot in how many processes you create to optimise the run time. A large number of python processes is generally not advisable, as it involves a large fixed cost in setting up many python interpreters and its supporting infrastructure. Play around with different numbers of processes in the pool(processes) statement to see how the runtime varies. Also, well developed libraries often have nicely optimised algorithms, you may not have to reinvent the wheel (Haha at this Python pun).</p>
</details>
</section>
</section>
<section id="useful-links" class="level2">
<h2 class="anchored" data-anchor-id="useful-links">Useful links</h2>
<p><a href="https://realpython.com/python-concurrency/">https://realpython.com/python-concurrency/</a></p>
<p><a href="https://docs.python.org/3/library/multiprocessing.html">https://docs.python.org/3/library/multiprocessing.html</a></p>
<p><a href="https://www.backblaze.com/blog/whats-the-diff-programs-processes-and-threads/">https://www.backblaze.com/blog/whats-the-diff-programs-processes-and-threads/</a></p>
<p><a href="https://pawseysc.github.io/training.html">https://pawseysc.github.io/training.html</a></p>
</section>
<section id="mpi-message-passing-interface" class="level2">
<h2 class="anchored" data-anchor-id="mpi-message-passing-interface">MPI: Message Passing Interface</h2>
<p>MPI is a standardized and portable message-passing system designed to function on a wide variety of parallel computers. The standard defines the syntax and semantics of a core of library routines useful to a wide range of users writing portable message-passing programs in C, C++, and Fortran. There are several well-tested and efficient implementations of MPI, many of which are open-source or in the public domain.</p>
<p>MPI for Python, found in <a href="https://mpi4py.readthedocs.io/en/stable/index.html">mpi4py</a>, provides bindings of the MPI standard for the Python programming language, allowing any Python program to exploit multiple processors. This simple code demonstrates the collection of resources and how code is run on different processes:</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!pip install mpi4py</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Run with:</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">#mpiexec -np 4 python mpi.py</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpi4py <span class="im">import</span> MPI</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>comm <span class="op">=</span> MPI.COMM_WORLD</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>size <span class="op">=</span> comm.Get_size()</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>rank <span class="op">=</span> comm.Get_rank()</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"I am rank </span><span class="sc">%d</span><span class="st"> in group of </span><span class="sc">%d</span><span class="st"> processes."</span> <span class="op">%</span> (rank, size))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>I am rank 0 in group of 1 processes.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Want more help on the MPI.COMM_WORLD class object?</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">#See the methods, functions, and variables associated with it.</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">#help(comm)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="key-points" class="level3 keypoints">
<h3 class="anchored" data-anchor-id="key-points">Key points</h3>
<ul>
<li>Understand there are different ways to accelerate</li>
<li>The best method depends on your algorithms, code and data</li>
<li>Load multiprocessing library to execute a function in a parallel manner</li>
</ul>
</section>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>