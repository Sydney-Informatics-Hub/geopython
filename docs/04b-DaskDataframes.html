<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>04b-DaskDataframes.utf8.md</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/simplex.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="lesson.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 41px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h2 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h3 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h4 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h5 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h6 {
  padding-top: 46px;
  margin-top: -46px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->



<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Home</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="setup.html">Setup</a>
    </li>
    <li>
      <a href="AWSinstuctionsStudents.html">AWS Backup instructions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Session 1
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="00-intro.html">Introduction</a>
    </li>
    <li>
      <a href="01a-fundamentals.html">Fundamentals</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Session 2
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="01b-dataframes.html">Useful Python packages for different data types</a>
    </li>
    <li>
      <a href="02a-mapping.html">Mapping with Cartopy</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Session 3
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="03a-MachineLearning.html">Machine Learning</a>
    </li>
    <li>
      <a href="03b-DeepLearningTS.html">Deep Learning &amp; Time Series</a>
    </li>
    <li>
      <a href="02b-Clustering.html">Numerical approaches</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Session 4
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="04a-SimpleSpeedUps.html">Simple Speed Ups</a>
    </li>
    <li>
      <a href="04b-DaskDataframes.html">Dask data frames</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<div id="working-with-big-data-using-dask" class="section level1">
<h1>Working with Big Data using Dask</h1>
<div id="questions" class="section level3 questions">
<h3>Questions</h3>
<ul>
<li>“Use a modern python library and elegant syntax for performance benefits”</li>
<li>“How do I deal with large irregular data and show me some real world examples of Dask”</li>
</ul>
</div>
<div id="objectives" class="section level3 objectives">
<h3>Objectives</h3>
<ul>
<li>“Intro to Dask concepts and High level datastructures”</li>
<li>“Use dask dataframes”</li>
<li>“Use dask delayed functions”</li>
<li>“Deal with semi-structured and unstructured data in memory efficient and parallel manner”</li>
<li>“Show me examples of using Dask on Large Datasets”</li>
</ul>
</div>
<div id="dask" class="section level2">
<h2>DASK</h2>
<p>Dask is a flexible library for parallel computing in Python.</p>
<p>Dask is composed of two parts: Dynamic task scheduling optimized for computation. This is similar to Airflow, Luigi, Celery, or Make, but optimized for interactive computational workloads. “Big Data” collections like parallel arrays, dataframes, and lists that extend common interfaces like <strong><em>NumPy, Pandas, or Python iterators</em></strong> to larger-than-memory or distributed environments. These parallel collections run on top of dynamic task schedulers.</p>
<p>Dask emphasizes the following virtues:</p>
<ul>
<li>Familiar: Provides parallelized NumPy array and Pandas DataFrame objects</li>
<li>Flexible: Provides a task scheduling interface for more custom workloads and integration with other projects.</li>
<li>Native: Enables distributed computing in pure Python with access to the PyData stack.</li>
<li>Fast: Operates with low overhead, low latency, and minimal serialization necessary for fast numerical algorithms</li>
<li>Scales up: Runs resiliently on clusters with 1000s of cores</li>
<li>Scales down: Trivial to set up and run on a laptop in a single process</li>
<li>Responsive: Designed with interactive computing in mind, it provides rapid feedback and diagnostics to aid humans</li>
</ul>
<figure>
<img src="fig/dask_pic1.png" style="margin:10px;width:600px"/>
<figcaption>
Dask High Level Schema <a href="https://docs.dask.org/en/latest/">https://docs.dask.org/en/latest/</a>
</figcaption>
</figure>
<p><br></p>
<p>Dask provides high level collections - these are <strong><em>Dask Dataframes, bags, and arrays</em></strong>. On a low level, dask dynamic task schedulers to scale up or down processes, and presents parallel computations by implementing task graphs. It provides an alternative to scaling out tasks instead of threading (IO Bound) and multiprocessing (cpu bound).</p>
<p>A Dask DataFrame is a large parallel DataFrame composed of many smaller Pandas DataFrames, split along the index. These Pandas DataFrames may live on disk for larger-than-memory computing on a single machine, or on many different machines in a cluster. One Dask DataFrame operation triggers many operations on the constituent Pandas DataFrames.</p>
<figure>
<img src="fig/dask_pic2.png" style="margin:6px;width:400px"/>
<figcaption>
Dask High Level Schema <a href="https://docs.dask.org/en/latest/dataframe.html/">https://docs.dask.org/en/latest/dataframe.html/</a>
</figcaption>
</figure>
<p><br></p>
<p>Common Use Cases: Dask DataFrame is used in situations where Pandas is commonly needed, usually when Pandas fails due to data size or computation speed: - Manipulating large datasets, even when those datasets don’t fit in memory - Accelerating long computations by using many cores - Distributed computing on large datasets with standard Pandas operations like groupby, join, and time series computations</p>
<p>Dask Dataframes <strong>may not be the best choice</strong> if: your data fits comfortable in RAM - Use pandas only! If you need a proper database. You need functions not implemented by dask dataframes - see Dask Delayed.</p>
</div>
<div id="dask-dataframes" class="section level2">
<h2>Dask Dataframes</h2>
<p>We will load in some data to explore.</p>
<pre class="python"><code>#Import dask dataframe modules
import dask.dataframe as dd

#NOTE: to run this example (with diagrams) you will need to &quot;pip install graphviz&quot; and donwload graphviz
#https://graphviz.org/download/
import os
os.environ[&quot;PATH&quot;] += os.pathsep + &#39;C:/APPS/Graphviz/bin&#39;</code></pre>
<pre class="python"><code># Setup a parlalle LocalCluster that makes use of all the cores and RAM we have on a single machine
from dask.distributed import Client, LocalCluster
cluster = LocalCluster()
# explicitly connect to the cluster we just created
client = Client(cluster)
client</code></pre>
<table style="border: 2px solid white;">
<tr>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">
Client
</h3>
<ul style="text-align: left; list-style: none; margin: 0; padding: 0;">
<li>
<b>Scheduler: </b>tcp://127.0.0.1:54234
</li>
<li>
<b>Dashboard: </b><a href='http://127.0.0.1:8787/status' target='_blank'>http://127.0.0.1:8787/status</a>
</li>
</ul>
</td>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">
Cluster
</h3>
<ul style="text-align: left; list-style:none; margin: 0; padding: 0;">
<li>
<b>Workers: </b>4
</li>
<li>
<b>Cores: </b>8
</li>
<li>
<b>Memory: </b>34.21 GB
</li>
</ul>
</td>
</tr>
</table>
<pre class="python"><code># Although this is small csv file, we&#39;ll reuse our same example from before!
# Load csv results from server into a Pandas DataFrame
df = dd.read_csv(&quot;../data/ml_data_points.csv&quot;)</code></pre>
<pre class="python"><code># We only see the metadata, the actual data are only computed when requested.
df</code></pre>
<div>
<strong>Dask DataFrame Structure:</strong>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
Unnamed: 0
</th>
<th>
0 Present day longitude (degrees)
</th>
<th>
1 Present day latitude (degrees)
</th>
<th>
2 Reconstructed longitude (degrees)
</th>
<th>
3 Reconstructed latitude (degrees)
</th>
<th>
4 Age (Ma)
</th>
<th>
5 Time before mineralisation (Myr)
</th>
<th>
6 Seafloor age (Myr)
</th>
<th>
7 Segment length (km)
</th>
<th>
8 Slab length (km)
</th>
<th>
9 Distance to trench edge (km)
</th>
<th>
10 Subducting plate normal velocity (km/Myr)
</th>
<th>
11 Subducting plate parallel velocity (km/Myr)
</th>
<th>
12 Overriding plate normal velocity (km/Myr)
</th>
<th>
13 Overriding plate parallel velocity (km/Myr)
</th>
<th>
14 Convergence normal rate (km/Myr)
</th>
<th>
15 Convergence parallel rate (km/Myr)
</th>
<th>
16 Subduction polarity (degrees)
</th>
<th>
17 Subduction obliquity (degrees)
</th>
<th>
18 Distance along margin (km)
</th>
<th>
19 Subduction obliquity signed (radians)
</th>
<th>
20 Ore Deposits Binary Flag (1 or 0)
</th>
</tr>
<tr>
<th>
npartitions=1
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
</th>
<td>
int64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
<td>
float64
</td>
</tr>
<tr>
<th>
</th>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
</tr>
</tbody>
</table>
</div>
<div>
Dask Name: read-csv, 1 tasks
</div>
<p>The concept of splitting the dask dataframe into pandas sub dataframes can be seen by the <strong><em>nopartitians=10</em></strong> output. This is the number of partitians the dataframe is split into and in this case was automatically calibrated, but can be specified. There is a trade off between splitting data too much that improves memory management, and the number of extra tasks it generates. For instance, if you have a 1000 GB of data and are using 10 MB chunks, then you have 100,000 partitions. Every operation on such a collection will generate at least 100,000 tasks. But more on this later. For now lets become familiar with some basic Dataframe operations.</p>
<p>Let’s inspect the data in its types, and also take the first 5 rows.</p>
<p>By default, dataframe operations are <strong><em>lazy</em></strong> meaning no computation takes place until specified. The <strong><em>.compute()</em></strong> triggers such a computation - and we will see later on that it converts a dask dataframe into a pandas dataframe. <strong><em>head(rows)</em></strong> also triggers a computation - but is really helpful in exploring the underlying data.</p>
<pre class="python"><code>df.head(5)</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
Unnamed: 0
</th>
<th>
0 Present day longitude (degrees)
</th>
<th>
1 Present day latitude (degrees)
</th>
<th>
2 Reconstructed longitude (degrees)
</th>
<th>
3 Reconstructed latitude (degrees)
</th>
<th>
4 Age (Ma)
</th>
<th>
5 Time before mineralisation (Myr)
</th>
<th>
6 Seafloor age (Myr)
</th>
<th>
7 Segment length (km)
</th>
<th>
8 Slab length (km)
</th>
<th>
…
</th>
<th>
11 Subducting plate parallel velocity (km/Myr)
</th>
<th>
12 Overriding plate normal velocity (km/Myr)
</th>
<th>
13 Overriding plate parallel velocity (km/Myr)
</th>
<th>
14 Convergence normal rate (km/Myr)
</th>
<th>
15 Convergence parallel rate (km/Myr)
</th>
<th>
16 Subduction polarity (degrees)
</th>
<th>
17 Subduction obliquity (degrees)
</th>
<th>
18 Distance along margin (km)
</th>
<th>
19 Subduction obliquity signed (radians)
</th>
<th>
20 Ore Deposits Binary Flag (1 or 0)
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
0
</td>
<td>
-66.28
</td>
<td>
-27.37
</td>
<td>
-65.264812
</td>
<td>
-28.103781
</td>
<td>
6.0
</td>
<td>
0.0
</td>
<td>
48.189707
</td>
<td>
56.08069
</td>
<td>
2436.30907
</td>
<td>
…
</td>
<td>
40.63020
</td>
<td>
-17.43987
</td>
<td>
12.20271
</td>
<td>
102.31471
</td>
<td>
28.82518
</td>
<td>
5.67505
</td>
<td>
15.73415
</td>
<td>
2269.19769
</td>
<td>
0.274613
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
1
</th>
<td>
1
</td>
<td>
-69.75
</td>
<td>
-30.50
</td>
<td>
-67.696759
</td>
<td>
-31.970639
</td>
<td>
12.0
</td>
<td>
0.0
</td>
<td>
52.321162
</td>
<td>
56.09672
</td>
<td>
2490.68735
</td>
<td>
…
</td>
<td>
39.60199
</td>
<td>
-22.80622
</td>
<td>
13.40127
</td>
<td>
115.35820
</td>
<td>
27.39401
</td>
<td>
5.78937
</td>
<td>
13.35854
</td>
<td>
1823.34107
</td>
<td>
0.233151
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
2
</th>
<td>
2
</td>
<td>
-66.65
</td>
<td>
-27.27
</td>
<td>
-65.128689
</td>
<td>
-28.374772
</td>
<td>
9.0
</td>
<td>
0.0
</td>
<td>
53.506085
</td>
<td>
55.77705
</td>
<td>
2823.54951
</td>
<td>
…
</td>
<td>
45.32425
</td>
<td>
-18.08485
</td>
<td>
11.27500
</td>
<td>
100.24282
</td>
<td>
34.62444
</td>
<td>
8.97218
</td>
<td>
19.05520
</td>
<td>
2269.19769
</td>
<td>
0.332576
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
3
</th>
<td>
3
</td>
<td>
-66.61
</td>
<td>
-27.33
</td>
<td>
-65.257928
</td>
<td>
-28.311094
</td>
<td>
8.0
</td>
<td>
0.0
</td>
<td>
51.317135
</td>
<td>
55.90088
</td>
<td>
2656.71724
</td>
<td>
…
</td>
<td>
43.13319
</td>
<td>
-17.78538
</td>
<td>
11.72618
</td>
<td>
101.21965
</td>
<td>
31.92962
</td>
<td>
7.42992
</td>
<td>
17.50782
</td>
<td>
2269.19769
</td>
<td>
0.305569
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
4
</th>
<td>
4
</td>
<td>
-66.55
</td>
<td>
-27.40
</td>
<td>
-65.366917
</td>
<td>
-28.257580
</td>
<td>
7.0
</td>
<td>
0.0
</td>
<td>
49.340097
</td>
<td>
56.09011
</td>
<td>
2547.29585
</td>
<td>
…
</td>
<td>
40.57322
</td>
<td>
-17.43622
</td>
<td>
12.23778
</td>
<td>
102.25748
</td>
<td>
28.80235
</td>
<td>
5.65657
</td>
<td>
15.73067
</td>
<td>
2269.19769
</td>
<td>
0.274552
</td>
<td>
1.0
</td>
</tr>
</tbody>
</table>
<p>
5 rows × 22 columns
</p>
</div>
<pre class="python"><code>df.columns</code></pre>
<pre><code>Index([&#39;Unnamed: 0&#39;, &#39;0 Present day longitude (degrees)&#39;,
       &#39;1 Present day latitude (degrees)&#39;,
       &#39;2 Reconstructed longitude (degrees)&#39;,
       &#39;3 Reconstructed latitude (degrees)&#39;, &#39;4 Age (Ma)&#39;,
       &#39;5 Time before mineralisation (Myr)&#39;, &#39;6 Seafloor age (Myr)&#39;,
       &#39;7 Segment length (km)&#39;, &#39;8 Slab length (km)&#39;,
       &#39;9 Distance to trench edge (km)&#39;,
       &#39;10 Subducting plate normal velocity (km/Myr)&#39;,
       &#39;11 Subducting plate parallel velocity (km/Myr)&#39;,
       &#39;12 Overriding plate normal velocity (km/Myr)&#39;,
       &#39;13 Overriding plate parallel velocity (km/Myr)&#39;,
       &#39;14 Convergence normal rate (km/Myr)&#39;,
       &#39;15 Convergence parallel rate (km/Myr)&#39;,
       &#39;16 Subduction polarity (degrees)&#39;, &#39;17 Subduction obliquity (degrees)&#39;,
       &#39;18 Distance along margin (km)&#39;,
       &#39;19 Subduction obliquity signed (radians)&#39;,
       &#39;20 Ore Deposits Binary Flag (1 or 0)&#39;],
      dtype=&#39;object&#39;)</code></pre>
<pre class="python"><code>#You can run typical pandas operations (generally faster! - but only noticeable on large data)
#group by operation - calculate the convergence rate by age. 
#Notice the compute() trigger that performs the operations.
#df.groupby(&#39;4 Age (Ma)&#39;)[&#39;14 Convergence normal rate (km/Myr)&#39;].mean()
df.groupby(&#39;4 Age (Ma)&#39;)[&#39;14 Convergence normal rate (km/Myr)&#39;].mean().compute()</code></pre>
<pre><code>4 Age (Ma)
1.0      66.594390
3.0      86.227770
4.0      76.746980
5.0      86.430612
6.0      96.153738
           ...    
175.0    30.189475
176.0    26.693450
177.0    15.504740
178.0    58.860860
179.0    65.671240
Name: 14 Convergence normal rate (km/Myr), Length: 126, dtype: float64</code></pre>
</div>
</div>
<div id="we-can-break-up-the-table-into-4-partions-to-map-out-to-each-core" class="section level1">
<h1>We can break up the table into 4 partions to map out to each core:</h1>
<p>df = df.repartition(npartitions=4) df</p>
<pre class="python"><code># Let&#39;s say we want to know the minimum last eruption year for all volcanoes
last_eruption_year_min = df[&#39;4 Age (Ma)&#39;].mean()
last_eruption_year_min</code></pre>
<pre><code>dd.Scalar&lt;series-..., dtype=float64&gt;</code></pre>
<pre class="python"><code># Instead of getting the actual value we see dd.Scalar, which represents a recipe for actually calculating this value
last_eruption_year_min.visualize(format=&#39;svg&#39;)</code></pre>
<div class="figure">
<img src="04b-DaskDataframes_files/04b-DaskDataframes_13_0.svg" alt="" />
<p class="caption">svg</p>
</div>
<pre class="python"><code># To get the value call the &#39;compute method&#39;
# NOTE: this was slower than using pandas directly,,, for small data you often don&#39;t need to use parallel computing!
last_eruption_year_min.compute()</code></pre>
<pre><code>66.19601328903654</code></pre>
<pre class="python"><code>import numpy as np
shape = (1000, 4000)
ones_np = np.ones(shape)
ones_np</code></pre>
<pre><code>array([[1., 1., 1., ..., 1., 1., 1.],
       [1., 1., 1., ..., 1., 1., 1.],
       [1., 1., 1., ..., 1., 1., 1.],
       ...,
       [1., 1., 1., ..., 1., 1., 1.],
       [1., 1., 1., ..., 1., 1., 1.],
       [1., 1., 1., ..., 1., 1., 1.]])</code></pre>
<pre class="python"><code>print(&#39;%.1f MB&#39; % (ones_np.nbytes / 1e6))</code></pre>
<pre><code>32.0 MB</code></pre>
<pre class="python"><code>import dask.array as da
ones = da.ones(shape)
ones</code></pre>
<table>
<tr>
<td>
<table>
<thead>
<tr>
<td>
</td>
<th>
Array
</th>
<th>
Chunk
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
Bytes
</th>
<td>
32.00 MB
</td>
<td>
32.00 MB
</td>
</tr>
<tr>
<th>
Shape
</th>
<td>
(1000, 4000)
</td>
<td>
(1000, 4000)
</td>
</tr>
<tr>
<th>
Count
</th>
<td>
1 Tasks
</td>
<td>
1 Chunks
</td>
</tr>
<tr>
<th>
Type
</th>
<td>
float64
</td>
<td>
numpy.ndarray
</td>
</tr>
</tbody>
</table>
</td>
<td>
<svg width="170" height="92" style="stroke:rgb(0,0,0);stroke-width:1">
<p><!-- Horizontal lines --> <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" /> <line x1="0" y1="42" x2="120" y2="42" style="stroke-width:2" /></p>
<p><!-- Vertical lines --> <line x1="0" y1="0" x2="0" y2="42" style="stroke-width:2" /> <line x1="120" y1="0" x2="120" y2="42" style="stroke-width:2" /></p>
<p><!-- Colored Rectangle --> <polygon points="0.0,0.0 120.0,0.0 120.0,42.89879552186203 0.0,42.89879552186203" style="fill:#ECB172A0;stroke-width:0"/></p>
<!-- Text --> <text x="60.000000" y="62.898796" font-size="1.0rem" font-weight="100" text-anchor="middle" >4000</text> <text x="140.000000" y="21.449398" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(-90,140.000000,21.449398)">1000</text>
</svg>
</td>
</tr>
</table>
<pre class="python"><code>chunk_shape = (1000, 1000)
ones = da.ones(shape, chunks=chunk_shape)
ones</code></pre>
<table>
<tr>
<td>
<table>
<thead>
<tr>
<td>
</td>
<th>
Array
</th>
<th>
Chunk
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
Bytes
</th>
<td>
32.00 MB
</td>
<td>
8.00 MB
</td>
</tr>
<tr>
<th>
Shape
</th>
<td>
(1000, 4000)
</td>
<td>
(1000, 1000)
</td>
</tr>
<tr>
<th>
Count
</th>
<td>
4 Tasks
</td>
<td>
4 Chunks
</td>
</tr>
<tr>
<th>
Type
</th>
<td>
float64
</td>
<td>
numpy.ndarray
</td>
</tr>
</tbody>
</table>
</td>
<td>
<svg width="170" height="92" style="stroke:rgb(0,0,0);stroke-width:1">
<p><!-- Horizontal lines --> <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" /> <line x1="0" y1="42" x2="120" y2="42" style="stroke-width:2" /></p>
<p><!-- Vertical lines --> <line x1="0" y1="0" x2="0" y2="42" style="stroke-width:2" /> <line x1="30" y1="0" x2="30" y2="42" /> <line x1="60" y1="0" x2="60" y2="42" /> <line x1="90" y1="0" x2="90" y2="42" /> <line x1="120" y1="0" x2="120" y2="42" style="stroke-width:2" /></p>
<p><!-- Colored Rectangle --> <polygon points="0.0,0.0 120.0,0.0 120.0,42.89879552186203 0.0,42.89879552186203" style="fill:#ECB172A0;stroke-width:0"/></p>
<!-- Text --> <text x="60.000000" y="62.898796" font-size="1.0rem" font-weight="100" text-anchor="middle" >4000</text> <text x="140.000000" y="21.449398" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(-90,140.000000,21.449398)">1000</text>
</svg>
</td>
</tr>
</table>
<pre class="python"><code>ones.compute()</code></pre>
<pre><code>array([[1., 1., 1., ..., 1., 1., 1.],
       [1., 1., 1., ..., 1., 1., 1.],
       [1., 1., 1., ..., 1., 1., 1.],
       ...,
       [1., 1., 1., ..., 1., 1., 1.],
       [1., 1., 1., ..., 1., 1., 1.],
       [1., 1., 1., ..., 1., 1., 1.]])</code></pre>
<pre class="python"><code>ones.visualize(format=&#39;svg&#39;)</code></pre>
<div class="figure">
<img src="04b-DaskDataframes_files/04b-DaskDataframes_20_0.svg" alt="" />
<p class="caption">svg</p>
</div>
<pre class="python"><code>sum_of_ones = ones.sum()
sum_of_ones.visualize(format=&#39;svg&#39;)</code></pre>
<div class="figure">
<img src="04b-DaskDataframes_files/04b-DaskDataframes_21_0.svg" alt="" />
<p class="caption">svg</p>
</div>
<pre class="python"><code>fancy_calculation = (ones * ones[::-1, ::-1]).mean()
fancy_calculation.visualize(format=&#39;svg&#39;)</code></pre>
<div class="figure">
<img src="04b-DaskDataframes_files/04b-DaskDataframes_22_0.svg" alt="" />
<p class="caption">svg</p>
</div>
<pre class="python"><code>bigshape = (200000, 4000)
big_ones = da.ones(bigshape, chunks=chunk_shape)
big_ones</code></pre>
<table>
<tr>
<td>
<table>
<thead>
<tr>
<td>
</td>
<th>
Array
</th>
<th>
Chunk
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
Bytes
</th>
<td>
6.40 GB
</td>
<td>
8.00 MB
</td>
</tr>
<tr>
<th>
Shape
</th>
<td>
(200000, 4000)
</td>
<td>
(1000, 1000)
</td>
</tr>
<tr>
<th>
Count
</th>
<td>
800 Tasks
</td>
<td>
800 Chunks
</td>
</tr>
<tr>
<th>
Type
</th>
<td>
float64
</td>
<td>
numpy.ndarray
</td>
</tr>
</tbody>
</table>
</td>
<td>
<svg width="79" height="170" style="stroke:rgb(0,0,0);stroke-width:1">
<p><!-- Horizontal lines --> <line x1="0" y1="0" x2="29" y2="0" style="stroke-width:2" /> <line x1="0" y1="6" x2="29" y2="6" /> <line x1="0" y1="12" x2="29" y2="12" /> <line x1="0" y1="18" x2="29" y2="18" /> <line x1="0" y1="25" x2="29" y2="25" /> <line x1="0" y1="31" x2="29" y2="31" /> <line x1="0" y1="37" x2="29" y2="37" /> <line x1="0" y1="43" x2="29" y2="43" /> <line x1="0" y1="50" x2="29" y2="50" /> <line x1="0" y1="56" x2="29" y2="56" /> <line x1="0" y1="63" x2="29" y2="63" /> <line x1="0" y1="69" x2="29" y2="69" /> <line x1="0" y1="75" x2="29" y2="75" /> <line x1="0" y1="81" x2="29" y2="81" /> <line x1="0" y1="88" x2="29" y2="88" /> <line x1="0" y1="94" x2="29" y2="94" /> <line x1="0" y1="100" x2="29" y2="100" /> <line x1="0" y1="106" x2="29" y2="106" /> <line x1="0" y1="113" x2="29" y2="113" /> <line x1="0" y1="120" x2="29" y2="120" style="stroke-width:2" /></p>
<p><!-- Vertical lines --> <line x1="0" y1="0" x2="0" y2="120" style="stroke-width:2" /> <line x1="7" y1="0" x2="7" y2="120" /> <line x1="14" y1="0" x2="14" y2="120" /> <line x1="21" y1="0" x2="21" y2="120" /> <line x1="29" y1="0" x2="29" y2="120" style="stroke-width:2" /></p>
<p><!-- Colored Rectangle --> <polygon points="0.0,0.0 29.030629010473877,0.0 29.030629010473877,120.0 0.0,120.0" style="fill:#8B4903A0;stroke-width:0"/></p>
<!-- Text --> <text x="14.515315" y="140.000000" font-size="1.0rem" font-weight="100" text-anchor="middle" >4000</text> <text x="49.030629" y="60.000000" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(-90,49.030629,60.000000)">200000</text>
</svg>
</td>
</tr>
</table>
<pre class="python"><code>print(&#39;%.1f MB&#39; % (big_ones.nbytes / 1e6))</code></pre>
<pre><code>6400.0 MB</code></pre>
<pre class="python"><code>big_calc = (big_ones * big_ones[::-1, ::-1]).mean()

result = big_calc.compute()
result</code></pre>
<pre><code>1.0</code></pre>
<pre class="python"><code>import time

def inc(x):
    time.sleep(0.1)
    return x + 1

def dec(x):
    time.sleep(0.1)
    return x - 1

def add(x, y):
    time.sleep(0.2)
    return x + y</code></pre>
<pre class="python"><code>%%time
x = inc(1)
y = dec(2)
z = add(x, y)
z</code></pre>
<pre><code>Wall time: 431 ms





3</code></pre>
<pre class="python"><code>import dask
inc = dask.delayed(inc)
dec = dask.delayed(dec)
add = dask.delayed(add)</code></pre>
<pre class="python"><code>%%time
x = inc(1)
y = dec(2)
z = add(x, y)
z</code></pre>
<pre><code>Wall time: 1.03 ms





Delayed(&#39;add-4336c3e8-9b9a-47b3-8c33-5da47dd0128c&#39;)</code></pre>
<pre class="python"><code>z.visualize(format=&#39;svg&#39;, rankdir=&#39;LR&#39;)</code></pre>
<div class="figure">
<img src="04b-DaskDataframes_files/04b-DaskDataframes_30_0.svg" alt="" />
<p class="caption">svg</p>
</div>
<pre class="python"><code>%%time
z.compute()</code></pre>
<pre><code>Wall time: 363 ms





3</code></pre>
<div id="helpful-links" class="section level2">
<h2>Helpful Links:</h2>
<p>Dask bag fundamentals <a href="https://docs.dask.org/en/latest/bag.html">https://docs.dask.org/en/latest/bag.html</a></p>
<p>Bag API’s: <a href="https://docs.dask.org/en/latest/bag.html">https://docs.dask.org/en/latest/bag-api.html</a></p>
<p>Dask bag limitations: <a href="https://docs.dask.org/en/latest/bag.html">https://docs.dask.org/en/latest/shared.html</a></p>
<p>Pangeo info: <a href="https://pangeo.io/#what-is-pangeo">https://pangeo.io/#what-is-pangeo</a></p>
<p>Xarray: <a href="http://xarray.pydata.org/en/stable/">http://xarray.pydata.org/en/stable/</a></p>
<p>Xarray API: <a href="http://xarray.pydata.org/en/stable/generated/xarray.open_dataset.html">http://xarray.pydata.org/en/stable/generated/xarray.open_dataset.html</a></p>
<p>Dask Dataframe intro <a href="https://docs.dask.org/en/latest/dataframe.html">https://docs.dask.org/en/latest/dataframe.html</a></p>
<p>API list for Dask Dataframes <a href="https://docs.dask.org/en/latest/dataframe-api.html">https://docs.dask.org/en/latest/dataframe.html</a></p>
<p>What are decorators <a href="https://realpython.com/primer-on-python-decorators/">https://realpython.com/primer-on-python-decorators/</a></p>
<div id="key-points" class="section level3 keypoints">
<h3>Key Points</h3>
<ul>
<li>“Dask builds on numpy and pandas APIs but operates in a parallel manner”</li>
<li>“Computations are by default lazy and must be triggered - this reduces unneccessary computation time”</li>
<li>“Dask Bag uses map filter and group by operations on python objects or semi/unstrucutred data”</li>
<li>“dask.multiprocessing is under the hood”</li>
<li>“Xarray is another option for holding netcdf data”</li>
</ul>
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
